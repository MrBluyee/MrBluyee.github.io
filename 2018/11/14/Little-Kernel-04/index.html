<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>Little Kernel 04 | Mr Bluyee's Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/latest/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/grids-responsive-min.min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/latest/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement('script');
  hm.src = 'https://hm.baidu.com/hm.js?' + '3dbaf3043b34b1c894c4cd063629b6a9';
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();</script><script type="text/javascript" src="//lib.baomitu.com/clipboard.js/latest/clipboard.min.js"></script><script type="text/javascript" src="//lib.baomitu.com/toastr.js/latest/toastr.min.js"></script><link rel="stylesheet" href="//lib.baomitu.com/toastr.js/latest/toastr.min.css"><meta name="generator" content="Hexo 7.1.1"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Little Kernel 04</h1><a id="logo" href="/.">Mr Bluyee's Blog</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Little Kernel 04</h1><div class="post-meta">2018-11-14<span> | </span><span class="category"><a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/">学习笔记——嵌入式开发</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 1.8k</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i><span class="post-count"> 10</span><span class="post-meta-item-text"> 分钟</span></span></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#LK-build-system"><span class="toc-number">1.</span> <span class="toc-text">LK build system</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Projects"><span class="toc-number">1.1.</span> <span class="toc-text">Projects</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Targets"><span class="toc-number">1.2.</span> <span class="toc-text">Targets</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Platforms"><span class="toc-number">1.3.</span> <span class="toc-text">Platforms</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Architectures"><span class="toc-number">1.4.</span> <span class="toc-text">Architectures</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Example-Project"><span class="toc-number">1.5.</span> <span class="toc-text">Example Project</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Building-Outside-The-LK-Tree"><span class="toc-number">2.</span> <span class="toc-text">Building Outside The LK Tree</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Details"><span class="toc-number">2.1.</span> <span class="toc-text">Details</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Alternate-Approach"><span class="toc-number">2.2.</span> <span class="toc-text">Alternate Approach</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%AD%A5%E9%AA%A4"><span class="toc-number">3.</span> <span class="toc-text">使用步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#build-essential"><span class="toc-number">3.1.</span> <span class="toc-text">build essential</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#for-arch-arm64-build"><span class="toc-number">3.2.</span> <span class="toc-text">for arch arm64 build</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#for-arch-arm-build"><span class="toc-number">3.3.</span> <span class="toc-text">for arch arm build</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#install-qemu"><span class="toc-number">3.4.</span> <span class="toc-text">install qemu</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#get-lk-code-and-build"><span class="toc-number">3.5.</span> <span class="toc-text">get lk code and build</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#qemu-run"><span class="toc-number">3.6.</span> <span class="toc-text">qemu run</span></a></li></ol></li></ol></div></div><div class="post-content"><h3 id="LK-build-system"><a href="#LK-build-system" class="headerlink" title="LK build system"></a>LK build system</h3><p>The LK build system thinks of the world in four layers.</p>
<span id="more"></span>


<h4 id="Projects"><a href="#Projects" class="headerlink" title="Projects"></a>Projects</h4><p>Projects are what you ask make to build.<br>They are a set of modules (typically apps and libraries) built for a Target. </p>
<p>They are defined in <strong>project&#x2F;name.mk</strong>. </p>
<p>The Target is selected via <strong>TARGET :&#x3D; name</strong>in this makefile or an included makefile (in the case where multiple projects share a common configuration). You choose your project by either passing it to make on the commandline (<strong>make name</strong>) or putting a <strong>PROJECT :&#x3D; name</strong> directive in local.mk.</p>
<h4 id="Targets"><a href="#Targets" class="headerlink" title="Targets"></a>Targets</h4><p>Targets are typically a specific PCB (or family of extremely closely related PCBs, maybe differing just a little, detectable by some revision resistors or the like). </p>
<p>They belong to a Platform and are defined in <strong>target&#x2F;name&#x2F;rules.mk</strong>.</p>
<p>The Platform is selected via <strong>PLATFORM :&#x3D; name</strong> in this makefile.</p>
<h4 id="Platforms"><a href="#Platforms" class="headerlink" title="Platforms"></a>Platforms</h4><p>Platforms typically are Systems-on-Chip (either individual or related families). </p>
<p>They belong to an Architecture and are defined in <strong>platform&#x2F;name&#x2F;rules.mk</strong>. </p>
<p>The Architecture is selected via <strong>ARCH :&#x3D; name</strong> in this makefile.</p>
<h4 id="Architectures"><a href="#Architectures" class="headerlink" title="Architectures"></a>Architectures</h4><p>Architectures are a specific CPU or CPU family (ARM Cortex M3, Intel IA32, etc).</p>
<h4 id="Example-Project"><a href="#Example-Project" class="headerlink" title="Example Project"></a>Example Project</h4><p>An example project is stm32f4-discovery-test. </p>
<p>The Target there is stm32f4-discovery (the ST development board of the same name). </p>
<p>Its Platform is stm32f4xx, a family of ST microcontrollers. STM32_CHIP is set to stm32f407 for things that may be specific to that chip. Some GLOBAL_DEFINES are configured here as well, like HSE_VALUE which is the frequency of the crystal — a platform-specific definition. </p>
<p>The Platform stm32f4xx sets ARCH as arm and ARM_CPU (specific to arm architecture) to cortex-m4, as well as configuring other platform-specific values.</p>
<p>The above configuration information lives in the following files in the lk source tree:</p>
<ul>
<li>project&#x2F;stm32f4-discovery-test.mk</li>
<li>target&#x2F;stm32f4-discovery&#x2F;rules.mk</li>
<li>platform&#x2F;stm32f4xx&#x2F;rules.mk</li>
<li>arch&#x2F;arm&#x2F;rules.mk</li>
</ul>
<h3 id="Building-Outside-The-LK-Tree"><a href="#Building-Outside-The-LK-Tree" class="headerlink" title="Building Outside The LK Tree"></a>Building Outside The LK Tree</h3><p>The build system provides a mechanism to overlay additional projects, targets, platforms, apps, libs, etc, from sibling directory hierarchies. This allows you to more easily build and maintain projects that are not part of the main lk tree.</p>
<p>For example, say you have LK checked out in an lk directory, and next to that you have a mystuff directory (a checkout of your own source tree). It can contain your own projects, libraries, and apps, like so:</p>
<ul>
<li>mystuff&#x2F;project&#x2F;toaster-oven.mk</li>
<li>mystuff&#x2F;target&#x2F;toaster-oven&#x2F;{rules.mk, init.c, …}</li>
<li>mystuff&#x2F;app&#x2F;toaster-ui&#x2F;{rules.mk, main.c, …}</li>
<li>mystuff&#x2F;lib&#x2F;cool-lcd&#x2F;{rules.mk, lcddriver.c, …}</li>
<li>mystuff&#x2F;lib&#x2F;pid-controller&#x2F;…</li>
</ul>
<p>If you copy lk&#x2F;makefile to mystuff&#x2F;makefile and create lk_inc.mk like so:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_DIR := mystuff</span><br><span class="line">LKMAKEROOT := ..</span><br><span class="line">LKROOT := lk</span><br><span class="line">LKINC := $(LOCAL_DIR)</span><br><span class="line">DEFAULT_PROJECT ?= toaster-oven</span><br><span class="line">BUILDROOT ?= $(LOCAL_DIR)</span><br></pre></td></tr></table></figure>
<p>You can then cd to mystuff and run make to build your project. You don’t need to modify anything in the main lk tree, so it’s easy to keep that up to date — no need to fork it, merge or rebase your changes, etc.</p>
<h4 id="Details"><a href="#Details" class="headerlink" title="Details"></a>Details</h4><ul>
<li><strong>LKMAKEROOT</strong> is the relative path from the overlay tree you’re building in to the directory that’s above the lk directory and any overlay tree directories (you can have multiple of these if you like). This variable is the only one that can have .. path elements in it. Such elements used anywhere else will cause the build system to misbehave.</li>
<li><strong>LKROOT</strong> is the path relative to LKMAKEROOT to LK itself.</li>
<li><strong>LKINC</strong> is the set of paths relative to LKMAKEROOT to overlay directories.</li>
<li><strong>DEFAULT_PROJECT</strong> does what it says — sets the project to build if another is not specified when make is invoked.</li>
<li><strong>BUILDROOT</strong> is relative to LKMAKEROOT and is the directory where build-$(PROJECT) will live, containing the build results.</li>
<li>You can also specify your <strong>TOOLCHAIN_PREFIX</strong> here to point at your chosen cross-compiler for this overlay.</li>
</ul>
<h4 id="Alternate-Approach"><a href="#Alternate-Approach" class="headerlink" title="Alternate Approach"></a>Alternate Approach</h4><p>If you’d rather run make from the top directory (that contains lk and mystuff), you can copy lk&#x2F;makefile and set up lk_inc.mk there instead. Just change the value of LKMAKEROOT and BUILDROOT both to . and you’re all set.</p>
<h3 id="使用步骤"><a href="#使用步骤" class="headerlink" title="使用步骤"></a>使用步骤</h3><h4 id="build-essential"><a href="#build-essential" class="headerlink" title="build essential"></a>build essential</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1.sudo apt-get install build-essential</span><br></pre></td></tr></table></figure>

<h4 id="for-arch-arm64-build"><a href="#for-arch-arm64-build" class="headerlink" title="for arch arm64 build"></a>for arch arm64 build</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1. mkdir -p gcc_linario_aarch64_toolchain</span><br><span class="line">2. cd gcc_linario_aarch64_toolchain</span><br><span class="line">3. wget -c https://releases.linaro.org/components/toolchain/binaries/latest-7/aarch64-elf/gcc-linaro-7.3.1-2018.05-x86_64_aarch64-elf.tar.xz</span><br><span class="line">4. tar xf gcc-linaro-7.3.1-2018.05-x86_64_aarch64-elf.tar.xz</span><br><span class="line">5. export PATH=$PATH:`pwd`/gcc-linaro-7.3.1-2018.05-x86_64_aarch64-elf/bin </span><br></pre></td></tr></table></figure>

<h4 id="for-arch-arm-build"><a href="#for-arch-arm-build" class="headerlink" title="for arch arm build"></a>for arch arm build</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1. mkdir -p arm-eabi-5.3.0-Linux-x86_64</span><br><span class="line">2. cd arm-eabi-5.3.0-Linux-x86_64</span><br><span class="line">3. wget -c http://newos.org/toolchains/arm-eabi-5.3.0-Linux-x86_64.tar.xz</span><br><span class="line">4. tar xf arm-eabi-5.3.0-Linux-x86_64.tar.xz</span><br><span class="line">5. export PATH=$PATH:`pwd`/arm-eabi-5.3.0-Linux-x86_64/bin</span><br></pre></td></tr></table></figure>

<h4 id="install-qemu"><a href="#install-qemu" class="headerlink" title="install qemu"></a>install qemu</h4><p>1.sudo apt-get install qemu<br>2.安装QEMU之后，命令行输入”qemu- + Tab”可以找到有如下的命令可用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">qemu-aarch64              qemu-make-debian-root     qemu-nios2                qemu-sparc32plus          qemu-system-microblazeel  qemu-system-ppc64le       qemu-system-xtensa</span><br><span class="line">qemu-alpha                qemu-microblaze           qemu-or1k                 qemu-sparc64              qemu-system-mips          qemu-system-ppcemb        qemu-system-xtensaeb</span><br><span class="line">qemu-arm                  qemu-microblazeel         qemu-ppc                  qemu-system-aarch64       qemu-system-mips64        qemu-system-s390x         qemu-tilegx</span><br><span class="line">qemu-armeb                qemu-mips                 qemu-ppc64                qemu-system-alpha         qemu-system-mips64el      qemu-system-sh4           qemu-x86_64</span><br><span class="line">qemu-cris                 qemu-mips64               qemu-ppc64abi32           qemu-system-arm           qemu-system-mipsel        qemu-system-sh4eb         </span><br><span class="line">qemu-hppa                 qemu-mips64el             qemu-ppc64le              qemu-system-cris          qemu-system-moxie         qemu-system-sparc         </span><br><span class="line">qemu-i386                 qemu-mipsel               qemu-s390x                qemu-system-i386          qemu-system-nios2         qemu-system-sparc64       </span><br><span class="line">qemu-img                  qemu-mipsn32              qemu-sh4                  qemu-system-lm32          qemu-system-or1k          qemu-system-tricore       </span><br><span class="line">qemu-io                   qemu-mipsn32el            qemu-sh4eb                qemu-system-m68k          qemu-system-ppc           qemu-system-unicore32     </span><br><span class="line">qemu-m68k                 qemu-nbd                  qemu-sparc                qemu-system-microblaze    qemu-system-ppc64         qemu-system-x86_64   </span><br></pre></td></tr></table></figure>
<p>可以看到它可以模拟很多种不同的架构。还有像qemu-img其实是一个工具，可以用来生成虚拟盘。<br>这里我们主要使用qemu-system-aarch64和qemu-system-arm。<br>3.可以查看qemu版本信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ qemu-system-arm -version</span><br><span class="line">QEMU emulator version 2.11.1(Debian 1:2.11+dfsg-1ubuntu7.7)</span><br><span class="line">Copyright (c) 2003-2017 Fabrice Bellard and the QEMU Project developers</span><br></pre></td></tr></table></figure>
<p>主要参数说明：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">1.支持的machine</span><br><span class="line">qemu-system-aarch64 -machine help</span><br><span class="line"></span><br><span class="line">其中，virt为：                 </span><br><span class="line">QEMU 2.11 ARM Virtual Machine (alias of virt-2.11)</span><br><span class="line"></span><br><span class="line">2.支持的cpu</span><br><span class="line">qemu-system-aarch64 -machine virt -cpu help</span><br><span class="line"></span><br><span class="line">其中，可以看到支持的arm cortex系列有：</span><br><span class="line">cortex-a15</span><br><span class="line">cortex-a53</span><br><span class="line">cortex-a57</span><br><span class="line">cortex-a7</span><br><span class="line">cortex-a8</span><br><span class="line">cortex-a9</span><br><span class="line">cortex-m3</span><br><span class="line">cortex-m4</span><br><span class="line">cortex-r5</span><br><span class="line"></span><br><span class="line">3.设置内存</span><br><span class="line">-m [size=]megs[,slots=n,maxmem=size]</span><br><span class="line">                configure guest RAM</span><br><span class="line">                size: initial amount of guest memory</span><br><span class="line">                slots: number of hotplug slots (default: none)</span><br><span class="line">                maxmem: maximum amount of guest memory (default: none)</span><br><span class="line"></span><br><span class="line">4.设置cpu核数</span><br><span class="line">-smp [cpus=]n[,maxcpus=cpus][,cores=cores][,threads=threads][,sockets=sockets]</span><br><span class="line">                set the number of CPUs to &#x27;n&#x27; [default=1]</span><br><span class="line">                maxcpus= maximum number of total cpus, including</span><br><span class="line">                offline CPUs for hotplug, etc</span><br><span class="line">                cores= number of CPU cores on one socket</span><br><span class="line">                threads= number of threads on one CPU core</span><br><span class="line">                sockets= number of discrete sockets in the system</span><br><span class="line">5.设置镜像文件</span><br><span class="line">-kernel bzImage use &#x27;bzImage&#x27; as kernel image</span><br></pre></td></tr></table></figure>
<p>示例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-arm  -M vexpress-a9 -m 512M -nographic -append &quot;console=ttyAMA0&quot; -kernel  /root/zImage-3.0</span><br><span class="line"></span><br><span class="line">-M vexpress-a9 模拟vexpress-a9单板</span><br><span class="line">-m 512M 单板运行物理内存512M</span><br><span class="line">-kernel /root/zImage-3.16  告诉qemu单板运行内核镜像路径</span><br><span class="line">-nographic 不使用图形化界面，只使用串口</span><br><span class="line">-append &quot;console=ttyAMA0&quot; 内核启动参数，这里告诉内核vexpress单板运行，串口设备是哪个tty。 </span><br></pre></td></tr></table></figure>

<h4 id="get-lk-code-and-build"><a href="#get-lk-code-and-build" class="headerlink" title="get lk code and build"></a>get lk code and build</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install git</span><br><span class="line"></span><br><span class="line">git clone https://github.com/littlekernel/lk</span><br><span class="line"></span><br><span class="line">cd lk/</span><br><span class="line"></span><br><span class="line">make list</span><br><span class="line">可以看到列出来的project list</span><br><span class="line"></span><br><span class="line">make list_name</span><br><span class="line">编译project list_name，例：</span><br><span class="line">make qemu-virt-a53-test</span><br><span class="line">编译完后，在lk下可以看到build-qemu-virt-a53-test文件夹，里面lk.elf即为生成的镜像文件</span><br></pre></td></tr></table></figure>
<p>我们看一下mk文件里定义了哪些内容：<br>lk&#x2F;project&#x2F;qemu-virt-a53-test.mk</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># main project for qemu-aarch64</span><br><span class="line">MODULES += \</span><br><span class="line">        app/shell</span><br><span class="line"></span><br><span class="line">include project/virtual/test.mk</span><br><span class="line">include project/virtual/fs.mk</span><br><span class="line">include project/virtual/minip.mk</span><br><span class="line">include project/target/qemu-virt-a53.mk</span><br></pre></td></tr></table></figure>

<p>lk&#x2F;project&#x2F;target&#x2F;qemu-virt-a53.mk</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># main project for qemu-aarch64</span><br><span class="line">ARCH := arm64</span><br><span class="line">ARM_CPU := cortex-a53</span><br><span class="line"></span><br><span class="line">include project/target/qemu-virt.mk</span><br></pre></td></tr></table></figure>

<p>lk&#x2F;project&#x2F;target&#x2F;qemu-virt.mk</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># main project for qemu-virt</span><br><span class="line">TARGET := qemu-virt</span><br><span class="line"></span><br><span class="line">WITH_LINKER_GC := 0</span><br></pre></td></tr></table></figure>

<p>lk&#x2F;project&#x2F;virtual&#x2F;fs.mk</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># modules related to a file system layer</span><br><span class="line"></span><br><span class="line">MODULES += \</span><br><span class="line">    lib/fs \</span><br><span class="line">    lib/fs/ext2 \</span><br><span class="line">    lib/fs/fat32 \</span><br><span class="line">    lib/fs/spifs \</span><br><span class="line">    lib/fs/spifs/test \</span><br><span class="line">    lib/fs/memfs</span><br></pre></td></tr></table></figure>

<p>lk&#x2F;project&#x2F;virtual&#x2F;test.mk</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># common libraries for -test variants</span><br><span class="line"></span><br><span class="line">MODULES += \</span><br><span class="line">  app/shell \</span><br><span class="line">  app/stringtests \</span><br><span class="line">  app/tests \</span><br><span class="line">  lib/aes \</span><br><span class="line">  lib/aes/test \</span><br><span class="line">  lib/cksum \</span><br><span class="line">  lib/debugcommands \</span><br><span class="line">  lib/libm \</span><br><span class="line">  lib/version \</span><br><span class="line"></span><br><span class="line">WITH_CPP_SUPPORT=true</span><br></pre></td></tr></table></figure>

<p>lk&#x2F;project&#x2F;virtual&#x2F;minip.mk</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># modules related to the minip stack</span><br><span class="line"></span><br><span class="line">MODULES += \</span><br><span class="line">    lib/minip \</span><br><span class="line">    app/inetsrv</span><br></pre></td></tr></table></figure>

<h4 id="qemu-run"><a href="#qemu-run" class="headerlink" title="qemu run"></a>qemu run</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-aarch64 -machine virt -cpu cortex-a53 -smp 1 -m 512M -kernel build-qemu-virt-a53-test/lk.elf</span><br></pre></td></tr></table></figure>
<p>可以看到有一个窗口弹出，默认为qemu console,Ctrl + Alt + 2切换到运行的系统的console，Ctrl + Alt + 1再切换回来。<br>在系统的console可以看到打印出来的启动过程：<br><img src="/images/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/little_kernel/QEMU01.PNG" alt="lk启动过程"></p>
<p>help 命令可以查看支持的测试指令。</p>
<p>命令添加参数-nographic -append “root&#x3D;&#x2F;dev&#x2F;ram init&#x3D;&#x2F;init console&#x3D;ttyS0”，可以重定向qemu的打印消息到当前console，这样就可以靠鼠标滚轮查看内核启动消息。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-aarch64 -machine virt -cpu cortex-a53 -smp 1 -m 512M -nographic -append &quot;root=/dev/ram init=/init console=ttyS0&quot; -kernel build-qemu-virt-a53-test/lk.elf</span><br></pre></td></tr></table></figure>
<p><img src="/images/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/little_kernel/QEMU02.PNG" alt="打印到当前console"></p>
</div><div class="post-copyright"><script type="text/javascript" src="/js/copyright.js?v=1.0.0" successtext="复制成功！"></script><link rel="stylesheet" type="text/css" href="/css/copyright.css?v=1.0.0"><p><span>本文标题：</span>Little Kernel 04</p><p><span>文章作者：</span>Mr Bluyee</p><p><span>发布时间：</span>2018-11-14</p><p><span>最后更新：</span>2019-07-15</p><p><span>原始链接：</span><a href="/2018/11/14/Little-Kernel-04/">https://www.mrbluyee.com/2018/11/14/Little-Kernel-04/</a><span class="copy-path"><i class="fa fa-clipboard" data-clipboard-text="https://www.mrbluyee.com/2018/11/14/Little-Kernel-04/"></i></span></p><p><span>版权声明：</span>The author owns the copyright, please indicate the source reproduced.</p></div><br><div class="tags"><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/" rel="tag">嵌入式开发</a></li></ul></div><div class="post-nav"><a class="pre" href="/2018/11/15/linux%E6%9F%A5%E6%89%BE%E5%91%BD%E4%BB%A4/">linux查找命令</a><a class="next" href="/2018/11/13/Little-Kernel-03/">Little Kernel 03</a></div><div id="lv-container" data-id="city" data-uid="MTAyMC8zOTYxNS8xNjE0Mg"><script>(function(d, s) {
  var j, e = d.getElementsByTagName(s)[0];
  if (typeof LivereTower === 'function') { return; }
  j = d.createElement(s);
  j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
  j.async = true;
  e.parentNode.insertBefore(j, e);
})(document, 'script');
</script></div></div></div></div><div class="pure-u-1 pure-u-md-1-4"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="author-info"><a class="info-avatar" href="/about/" title="关于"><img class="nofancybox" src="/img/avatar.jpeg"/></a><p>Enjoy life / Hope for future</p><a class="info-icon" href="mr.bluyee@hotmail.com" title="mr.bluyee@hotmail.com" target="_blank" style="margin-inline:5px"> <i class="fa fa-envelope-square" style="margin-inline:5px"></i></a><a class="info-icon" href="https://github.com/MrBluyee" title="https://github.com/MrBluyee" target="_blank" style="margin-inline:5px"> <i class="fa fa-github-square" style="margin-inline:5px"></i></a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94AI/">学习笔记——AI</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94C-%E7%AE%97%E6%B3%95/">学习笔记——C 算法</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94C%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">学习笔记——C数据结构</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94Python/">学习笔记——Python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94android/">学习笔记——android</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94data-compression/">学习笔记——data compression</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94expert-c-programming/">学习笔记——expert c programming</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94linux/">学习笔记——linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94opencv/">学习笔记——opencv</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E4%BB%A3%E7%A0%81%E7%AE%A1%E7%90%86/">学习笔记——代码管理</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E4%BD%8E%E5%8A%9F%E8%80%97%E6%8A%80%E6%9C%AF/">学习笔记——低功耗技术</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/">学习笔记——嵌入式开发</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/">学习笔记——机器学习</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E7%89%A9%E8%81%94%E7%BD%91/">学习笔记——物联网</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/">学习笔记——网络协议</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F/">学习笔记——计算机系统</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F/" style="font-size: 15px;">计算机系统</a> <a href="/tags/android/" style="font-size: 15px;">android</a> <a href="/tags/C/" style="font-size: 15px;">C</a> <a href="/tags/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/" style="font-size: 15px;">网络协议</a> <a href="/tags/Python/" style="font-size: 15px;">Python</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/" style="font-size: 15px;">嵌入式开发</a> <a href="/tags/AI/" style="font-size: 15px;">AI</a> <a href="/tags/data-compression/" style="font-size: 15px;">data compression</a> <a href="/tags/opencv/" style="font-size: 15px;">opencv</a> <a href="/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/" style="font-size: 15px;">机器学习</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2024/04/02/anything-LLM-with-ollama-a-private-document-chatbot/">anything LLM with ollama - a private document chatbot</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/04/02/open-webui-with-ollama-ChatGPT-like-interface/">open-webui with ollama - ChatGPT like interface</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/04/02/ollama-run-large-language-models-locally/">ollama - run large language models locally</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/03/28/huffman-coding-in-deflate/">huffman coding in deflate</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/03/25/zlib-and-gzip-format/">zlib and gzip format</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/03/23/deflate%20format/">deflate format</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/23/IPsec/">IPsec</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/07/21/%E6%95%B0%E7%9A%84%E7%B4%A0%E6%80%A7%E6%B5%8B%E8%AF%95/">数的素性测试</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/07/20/%E6%89%A9%E5%B1%95%E7%9A%84%E6%AC%A7%E5%87%A0%E9%87%8C%E5%BE%97%E7%AE%97%E6%B3%95/">扩展的欧几里得算法</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/07/17/%E6%AC%A7%E5%87%A0%E9%87%8C%E5%BE%97%E7%AE%97%E6%B3%95-%E6%B1%82%E6%9C%80%E5%A4%A7%E5%85%AC%E5%9B%A0%E6%95%B0/">欧几里得算法-求最大公因数</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2024 <a href="/." rel="nofollow">Mr Bluyee's Blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.js"></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0"></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.css"><link rel="stylesheet" type="text/css" href="/css/search.css?v=1.0.0"><script type="text/javascript" src="/js/search.js?v=1.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
  search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/copycode.js?v=1.0.0" successtext="复制成功！"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css?v=1.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>