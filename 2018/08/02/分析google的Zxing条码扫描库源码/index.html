<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>分析google的Zxing条码扫描库源码 | Mr Bluyee's Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/latest/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/grids-responsive-min.min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/latest/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement('script');
  hm.src = 'https://hm.baidu.com/hm.js?' + '3dbaf3043b34b1c894c4cd063629b6a9';
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();</script><script type="text/javascript" src="//lib.baomitu.com/clipboard.js/latest/clipboard.min.js"></script><script type="text/javascript" src="//lib.baomitu.com/toastr.js/latest/toastr.min.js"></script><link rel="stylesheet" href="//lib.baomitu.com/toastr.js/latest/toastr.min.css"><meta name="generator" content="Hexo 7.1.1"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">分析google的Zxing条码扫描库源码</h1><a id="logo" href="/.">Mr Bluyee's Blog</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">分析google的Zxing条码扫描库源码</h1><div class="post-meta">2018-08-02<span> | </span><span class="category"><a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94android/">学习笔记——android</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 2.7k</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i><span class="post-count"> 15</span><span class="post-meta-item-text"> 分钟</span></span></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#android%E6%96%87%E4%BB%B6%E5%A4%B9%EF%BC%9A"><span class="toc-number">1.</span> <span class="toc-text">android文件夹：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#CaptureActivity-java"><span class="toc-number">1.1.</span> <span class="toc-text">CaptureActivity.java</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CaptureActivityHandler-java"><span class="toc-number">1.2.</span> <span class="toc-text">CaptureActivityHandler.java</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DecodeThread-java%EF%BC%9A"><span class="toc-number">1.3.</span> <span class="toc-text">DecodeThread.java：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DecodeHandler-java%EF%BC%9A"><span class="toc-number">1.4.</span> <span class="toc-text">DecodeHandler.java：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#core%E6%96%87%E4%BB%B6%E5%A4%B9%EF%BC%9A"><span class="toc-number">2.</span> <span class="toc-text">core文件夹：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MultiFormatReader-java"><span class="toc-number">2.1.</span> <span class="toc-text">MultiFormatReader.java</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#QRCodeReader-java"><span class="toc-number">2.2.</span> <span class="toc-text">QRCodeReader.java</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Decoder-java"><span class="toc-number">2.3.</span> <span class="toc-text">Decoder.java:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Detector-java"><span class="toc-number">2.4.</span> <span class="toc-text">Detector.java:</span></a></li></ol></li></ol></div></div><div class="post-content"><p>ZXing是一个开放源码的，用Java实现的多种格式的条码扫描与生成库。<br>Zxing的GITHUB地址：<a target="_blank" rel="noopener" href="https://github.com/zxing/zxing">Zxing</a></p>
<span id="more"></span>

<p>ZXing支持的格式：</p>
<table>
<thead>
<tr>
<th>1D product</th>
<th>1D industrial</th>
<th>2D</th>
</tr>
</thead>
<tbody><tr>
<td>UPC-A</td>
<td>Code 39</td>
<td>QR Code</td>
</tr>
<tr>
<td>UPC-E</td>
<td>Code 93</td>
<td>Data Matrix</td>
</tr>
<tr>
<td>EAN-8</td>
<td>Code 128</td>
<td>Aztec (beta)</td>
</tr>
<tr>
<td>EAN-13</td>
<td>Codabar</td>
<td>PDF 417 (beta)</td>
</tr>
<tr>
<td></td>
<td>ITF</td>
<td>MaxiCode</td>
</tr>
<tr>
<td></td>
<td>RSS-14</td>
<td></td>
</tr>
<tr>
<td></td>
<td>RSS-Expanded</td>
<td></td>
</tr>
</tbody></table>
<p>zxing代码库结构及其介绍如下：</p>
<table>
<thead>
<tr>
<th>Module</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>core</td>
<td>The core image decoding library, and test code</td>
</tr>
<tr>
<td>javase</td>
<td>JavaSE-specific client code</td>
</tr>
<tr>
<td>android</td>
<td>Android client Barcode Scanner</td>
</tr>
<tr>
<td>android-integration</td>
<td>Supports integration with Barcode Scanner via Intent</td>
</tr>
<tr>
<td>android-core</td>
<td>Android-related code shared among android, other Android apps</td>
</tr>
<tr>
<td>zxingorg</td>
<td>The source behind zxing.org</td>
</tr>
<tr>
<td>zxing.appspot.com</td>
<td>The source behind web-based barcode generator at zxing.appspot.com</td>
</tr>
</tbody></table>
<p>这篇文章主要分析android上是如何调用zxing去识别二维码的。<br>先在GITHUB上下载源码，目前最新的版本是3.3.3。解压并打开文件夹，我们主要看android、android-core和core这三个文件夹。</p>
<h3 id="android文件夹："><a href="#android文件夹：" class="headerlink" title="android文件夹："></a>android文件夹：</h3><p>在“zxing-zxing-3.3.3\android\src\com\google\zxing\client\android”下有android的src代码。</p>
<h4 id="CaptureActivity-java"><a href="#CaptureActivity-java" class="headerlink" title="CaptureActivity.java"></a>CaptureActivity.java</h4><p>主界面是CaptureActivity.java。在CaptureActivity.java中，cameraManager用于调用摄像头。<br>摄像头的初始化：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">private void initCamera(SurfaceHolder surfaceHolder) &#123;</span><br><span class="line">  if (surfaceHolder == null) &#123;</span><br><span class="line">    throw new IllegalStateException(&quot;No SurfaceHolder provided&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">  if (cameraManager.isOpen()) &#123;</span><br><span class="line">    Log.w(TAG, &quot;initCamera() while already open -- late SurfaceView callback?&quot;);</span><br><span class="line">    return;</span><br><span class="line">  &#125;</span><br><span class="line">  try &#123;</span><br><span class="line">    cameraManager.openDriver(surfaceHolder);</span><br><span class="line">    // Creating the handler starts the preview, which can also throw a RuntimeException.</span><br><span class="line">    if (handler == null) &#123;</span><br><span class="line">      handler = new CaptureActivityHandler(this, decodeFormats, decodeHints, characterSet, cameraManager);</span><br><span class="line">    &#125;</span><br><span class="line">    decodeOrStoreSavedBitmap(null, null);</span><br><span class="line">  &#125; catch (IOException ioe) &#123;</span><br><span class="line">    Log.w(TAG, ioe);</span><br><span class="line">    displayFrameworkBugMessageAndExit();</span><br><span class="line">  &#125; catch (RuntimeException e) &#123;</span><br><span class="line">    // Barcode Scanner has seen crashes in the wild of this variety:</span><br><span class="line">    // java.?lang.?RuntimeException: Fail to connect to camera service</span><br><span class="line">    Log.w(TAG, &quot;Unexpected error initializing camera&quot;, e);</span><br><span class="line">    displayFrameworkBugMessageAndExit();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到在打开摄像头后，即调用CaptureActivityHandler进行识别操作：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cameraManager.openDriver(surfaceHolder);</span><br><span class="line">// Creating the handler starts the preview, which can also throw a RuntimeException.</span><br><span class="line">if (handler == null) &#123;</span><br><span class="line">  handler = new CaptureActivityHandler(this, decodeFormats, decodeHints, characterSet, cameraManager);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>摄像头预览的内容是放在名为preview_view的SurfaceView容器里的。CaptureActivity extends Activity implements SurfaceHolder.Callback并重写了这三个Surface的Callback函数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void surfaceCreated(SurfaceHolder holder) &#123;</span><br><span class="line">  if (holder == null) &#123;</span><br><span class="line">    Log.e(TAG, &quot;*** WARNING *** surfaceCreated() gave us a null surface!&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">  if (!hasSurface) &#123;</span><br><span class="line">    hasSurface = true;</span><br><span class="line">    initCamera(holder);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public void surfaceDestroyed(SurfaceHolder holder) &#123;</span><br><span class="line">  hasSurface = false;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public void surfaceChanged(SurfaceHolder holder, int format, int width, int height) &#123;</span><br><span class="line">  // do nothing</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用  public void handleDecode(Result rawResult, Bitmap barcode, float scaleFactor)来处理返回到这层的识别的数据：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * A valid barcode has been found, so give an indication of success and show the results.</span><br><span class="line"> *</span><br><span class="line"> * @param rawResult The contents of the barcode.</span><br><span class="line"> * @param scaleFactor amount by which thumbnail was scaled</span><br><span class="line"> * @param barcode   A greyscale bitmap of the camera data which was decoded.</span><br><span class="line"> */</span><br><span class="line">public void handleDecode(Result rawResult, Bitmap barcode, float scaleFactor) &#123;</span><br></pre></td></tr></table></figure>
<p>这其中，处理又有两种方式：内部方式和外部方式。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">switch (source) &#123;</span><br><span class="line">  case NATIVE_APP_INTENT:</span><br><span class="line">  case PRODUCT_SEARCH_LINK:</span><br><span class="line">    handleDecodeExternally(rawResult, resultHandler, barcode);</span><br><span class="line">    break;</span><br><span class="line">  case ZXING_LINK:</span><br><span class="line">    if (scanFromWebPageManager == null || !scanFromWebPageManager.isScanFromWebPage()) &#123;</span><br><span class="line">      handleDecodeInternally(rawResult, resultHandler, barcode);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      handleDecodeExternally(rawResult, resultHandler, barcode);</span><br><span class="line">    &#125;</span><br><span class="line">    break;</span><br><span class="line">  case NONE:</span><br><span class="line">    SharedPreferences prefs = PreferenceManager.getDefaultSharedPreferences(this);</span><br><span class="line">    if (fromLiveScan &amp;&amp; prefs.getBoolean(PreferencesActivity.KEY_BULK_MODE, false)) &#123;</span><br><span class="line">      Toast.makeText(getApplicationContext(),</span><br><span class="line">                     getResources().getString(R.string.msg_bulk_mode_scanned) + &quot; (&quot; + rawResult.getText() + &#x27;)&#x27;,</span><br><span class="line">                     Toast.LENGTH_SHORT).show();</span><br><span class="line">      maybeSetClipboard(resultHandler);</span><br><span class="line">      // Wait a moment or else it will scan the same barcode continuously about 3 times</span><br><span class="line">      restartPreviewAfterDelay(BULK_MODE_SCAN_DELAY_MS);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      handleDecodeInternally(rawResult, resultHandler, barcode);</span><br><span class="line">    &#125;</span><br><span class="line">    break;+</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>handleDecodeInternally主要是在UI上做显示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// Put up our own UI for how to handle the decoded contents.</span><br><span class="line">private void handleDecodeInternally(Result rawResult, ResultHandler resultHandler, Bitmap barcode) &#123;</span><br></pre></td></tr></table></figure>
<p>而handleDecodeExternally则进一步往上一层传，如果外部有调用的话：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// Briefly show the contents of the barcode, then handle the result outside Barcode Scanner.</span><br><span class="line">private void handleDecodeExternally(Result rawResult, ResultHandler resultHandler, Bitmap barcode) &#123;</span><br></pre></td></tr></table></figure>
<h4 id="CaptureActivityHandler-java"><a href="#CaptureActivityHandler-java" class="headerlink" title="CaptureActivityHandler.java"></a>CaptureActivityHandler.java</h4><p>在CaptureActivity调用了CaptureActivityHandler后，参数仅一步传递到DecodeThread:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">CaptureActivityHandler(CaptureActivity activity,</span><br><span class="line">                       Collection&lt;BarcodeFormat&gt; decodeFormats,</span><br><span class="line">                       Map&lt;DecodeHintType,?&gt; baseHints,</span><br><span class="line">                       String characterSet,</span><br><span class="line">                       CameraManager cameraManager) &#123;</span><br><span class="line">  this.activity = activity;</span><br><span class="line">  decodeThread = new DecodeThread(activity, decodeFormats, baseHints, characterSet,</span><br><span class="line">      new ViewfinderResultPointCallback(activity.getViewfinderView()));</span><br><span class="line">  decodeThread.start();</span><br><span class="line">  state = State.SUCCESS;</span><br><span class="line"></span><br><span class="line">  // Start ourselves capturing previews and decoding.</span><br><span class="line">  this.cameraManager = cameraManager;</span><br><span class="line">  cameraManager.startPreview();</span><br><span class="line">  restartPreviewAndDecode();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此外，CaptureActivityHandler继承了handle，并重写了handleMessage方法，从而使用CaptureActivityHandler来为CaptureActivity处理底层的消息。调用过程：<br>在CaptureActivity的onActivityResult方法中获取返回的信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void onActivityResult(int requestCode, int resultCode, Intent intent) &#123;</span><br><span class="line">  if (resultCode == RESULT_OK &amp;&amp; requestCode == HISTORY_REQUEST_CODE &amp;&amp; historyManager != null) &#123;</span><br><span class="line">    int itemNumber = intent.getIntExtra(Intents.History.ITEM_NUMBER, -1);</span><br><span class="line">    if (itemNumber &gt;= 0) &#123;</span><br><span class="line">      HistoryItem historyItem = historyManager.buildHistoryItem(itemNumber);</span><br><span class="line">      decodeOrStoreSavedBitmap(null, historyItem.getResult());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这其中，返回的信息被保存至历史记录，并在decodeOrStoreSavedBitmap函数里将消息传递到CaptureActivityHandler的handleMessage：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">private void decodeOrStoreSavedBitmap(Bitmap bitmap, Result result) &#123;</span><br><span class="line">  // Bitmap isn&#x27;t used yet -- will be used soon</span><br><span class="line">  if (handler == null) &#123;</span><br><span class="line">    savedResultToShow = result;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    if (result != null) &#123;</span><br><span class="line">      savedResultToShow = result;</span><br><span class="line">    &#125;</span><br><span class="line">    if (savedResultToShow != null) &#123;</span><br><span class="line">      Message message = Message.obtain(handler, R.id.decode_succeeded, savedResultToShow);</span><br><span class="line">      handler.sendMessage(message);</span><br><span class="line">    &#125;</span><br><span class="line">    savedResultToShow = null;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在handleMessage里调用了前面所说的CaptureActivity里的handleDecode的方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">case R.id.decode_succeeded:</span><br><span class="line">  state = State.SUCCESS;</span><br><span class="line">  Bundle bundle = message.getData();</span><br><span class="line">  Bitmap barcode = null;</span><br><span class="line">  float scaleFactor = 1.0f;</span><br><span class="line">  if (bundle != null) &#123;</span><br><span class="line">    byte[] compressedBitmap = bundle.getByteArray(DecodeThread.BARCODE_BITMAP);</span><br><span class="line">    if (compressedBitmap != null) &#123;</span><br><span class="line">      barcode = BitmapFactory.decodeByteArray(compressedBitmap, 0, compressedBitmap.length, null);</span><br><span class="line">      // Mutable copy:</span><br><span class="line">      barcode = barcode.copy(Bitmap.Config.ARGB_8888, true);</span><br><span class="line">    &#125;</span><br><span class="line">    scaleFactor = bundle.getFloat(DecodeThread.BARCODE_SCALED_FACTOR);          </span><br><span class="line">  &#125;</span><br><span class="line">  activity.handleDecode((Result) message.obj, barcode, scaleFactor);</span><br><span class="line">  break;</span><br></pre></td></tr></table></figure>
<h4 id="DecodeThread-java："><a href="#DecodeThread-java：" class="headerlink" title="DecodeThread.java："></a>DecodeThread.java：</h4><p>DecodeThread是一个线程，继承了Thread。<br>其初始化里添加了decodeFormats的内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">DecodeThread(CaptureActivity activity,</span><br><span class="line">             Collection&lt;BarcodeFormat&gt; decodeFormats,</span><br><span class="line">             Map&lt;DecodeHintType,?&gt; baseHints,</span><br><span class="line">             String characterSet,</span><br><span class="line">             ResultPointCallback resultPointCallback) &#123;</span><br><span class="line"></span><br><span class="line">  this.activity = activity;</span><br><span class="line">  handlerInitLatch = new CountDownLatch(1);</span><br><span class="line"></span><br><span class="line">  hints = new EnumMap&lt;&gt;(DecodeHintType.class);</span><br><span class="line">  if (baseHints != null) &#123;</span><br><span class="line">    hints.putAll(baseHints);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // The prefs can&#x27;t change while the thread is running, so pick them up once here.</span><br><span class="line">  if (decodeFormats == null || decodeFormats.isEmpty()) &#123;</span><br><span class="line">    SharedPreferences prefs = PreferenceManager.getDefaultSharedPreferences(activity);</span><br><span class="line">    decodeFormats = EnumSet.noneOf(BarcodeFormat.class);</span><br><span class="line">    if (prefs.getBoolean(PreferencesActivity.KEY_DECODE_1D_PRODUCT, true)) &#123;</span><br><span class="line">      decodeFormats.addAll(DecodeFormatManager.PRODUCT_FORMATS);</span><br><span class="line">    &#125;</span><br><span class="line">    if (prefs.getBoolean(PreferencesActivity.KEY_DECODE_1D_INDUSTRIAL, true)) &#123;</span><br><span class="line">      decodeFormats.addAll(DecodeFormatManager.INDUSTRIAL_FORMATS);</span><br><span class="line">    &#125;</span><br><span class="line">    if (prefs.getBoolean(PreferencesActivity.KEY_DECODE_QR, true)) &#123;</span><br><span class="line">      decodeFormats.addAll(DecodeFormatManager.QR_CODE_FORMATS);</span><br><span class="line">    &#125;</span><br><span class="line">    if (prefs.getBoolean(PreferencesActivity.KEY_DECODE_DATA_MATRIX, true)) &#123;</span><br><span class="line">      decodeFormats.addAll(DecodeFormatManager.DATA_MATRIX_FORMATS);</span><br><span class="line">    &#125;</span><br><span class="line">    if (prefs.getBoolean(PreferencesActivity.KEY_DECODE_AZTEC, false)) &#123;</span><br><span class="line">      decodeFormats.addAll(DecodeFormatManager.AZTEC_FORMATS);</span><br><span class="line">    &#125;</span><br><span class="line">    if (prefs.getBoolean(PreferencesActivity.KEY_DECODE_PDF417, false)) &#123;</span><br><span class="line">      decodeFormats.addAll(DecodeFormatManager.PDF417_FORMATS);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  hints.put(DecodeHintType.POSSIBLE_FORMATS, decodeFormats);</span><br><span class="line"></span><br><span class="line">  if (characterSet != null) &#123;</span><br><span class="line">    hints.put(DecodeHintType.CHARACTER_SET, characterSet);</span><br><span class="line">  &#125;</span><br><span class="line">  hints.put(DecodeHintType.NEED_RESULT_POINT_CALLBACK, resultPointCallback);</span><br><span class="line">  Log.i(&quot;DecodeThread&quot;, &quot;Hints: &quot; + hints);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在其run方法里通向下一层调用的方法DecodeHandler：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void run() &#123;</span><br><span class="line">  Looper.prepare();</span><br><span class="line">  handler = new DecodeHandler(activity, hints);</span><br><span class="line">  handlerInitLatch.countDown();</span><br><span class="line">  Looper.loop();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="DecodeHandler-java："><a href="#DecodeHandler-java：" class="headerlink" title="DecodeHandler.java："></a>DecodeHandler.java：</h4><p>DecodeHandler继承Handler，在handleMessage里调用该class里的decode函数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void handleMessage(Message message) &#123;</span><br><span class="line">  if (message == null || !running) &#123;</span><br><span class="line">    return;</span><br><span class="line">  &#125;</span><br><span class="line">  switch (message.what) &#123;</span><br><span class="line">    case R.id.decode:</span><br><span class="line">      decode((byte[]) message.obj, message.arg1, message.arg2);</span><br><span class="line">      break;</span><br><span class="line">    case R.id.quit:</span><br><span class="line">      running = false;</span><br><span class="line">      Looper.myLooper().quit();</span><br><span class="line">      break;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>decode函数完成了解码和解码结果的数据回传，android的调用core的解码的接口就在decode里：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">private void decode(byte[] data, int width, int height) &#123;</span><br><span class="line">  long start = System.currentTimeMillis();</span><br><span class="line">  Result rawResult = null;</span><br><span class="line">  PlanarYUVLuminanceSource source = activity.getCameraManager().buildLuminanceSource(data, width, height);</span><br><span class="line">  if (source != null) &#123;</span><br><span class="line">    BinaryBitmap bitmap = new BinaryBitmap(new HybridBinarizer(source));</span><br><span class="line">    try &#123;</span><br><span class="line">      rawResult = multiFormatReader.decodeWithState(bitmap);</span><br><span class="line">    &#125; catch (ReaderException re) &#123;</span><br><span class="line">      // continue</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">      multiFormatReader.reset();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Handler handler = activity.getHandler();</span><br><span class="line">  if (rawResult != null) &#123;</span><br><span class="line">    // Don&#x27;t log the barcode contents for security.</span><br><span class="line">    long end = System.currentTimeMillis();</span><br><span class="line">    Log.d(TAG, &quot;Found barcode in &quot; + (end - start) + &quot; ms&quot;);</span><br><span class="line">    if (handler != null) &#123;</span><br><span class="line">      Message message = Message.obtain(handler, R.id.decode_succeeded, rawResult);</span><br><span class="line">      Bundle bundle = new Bundle();</span><br><span class="line">      bundleThumbnail(source, bundle);        </span><br><span class="line">      message.setData(bundle);</span><br><span class="line">      message.sendToTarget();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    if (handler != null) &#123;</span><br><span class="line">      Message message = Message.obtain(handler, R.id.decode_failed);</span><br><span class="line">      message.sendToTarget();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>decode调用的底层函数为：rawResult &#x3D; multiFormatReader.decodeWithState(bitmap);<br>安卓层扫码大致流程如下图所示：<br><img src="https://upload-images.jianshu.io/upload_images/9169686-4c0cad7568704ecb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="安卓层扫码大致流程"></p>
<h3 id="core文件夹："><a href="#core文件夹：" class="headerlink" title="core文件夹："></a>core文件夹：</h3><p>在“zxing-zxing-3.3.3\core\src\main\java\com\google\zxing”下有core的src代码。</p>
<h4 id="MultiFormatReader-java"><a href="#MultiFormatReader-java" class="headerlink" title="MultiFormatReader.java"></a>MultiFormatReader.java</h4><p>MultiFormatReader支持读取多种格式的码的内容，我们只看二维码部分：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if (formats.contains(BarcodeFormat.QR_CODE)) &#123;</span><br><span class="line">  readers.add(new QRCodeReader());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>new一个QRCodeReader()实例，解码在decodeInternal里调用reader.decode(image, hints)：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">private Result decodeInternal(BinaryBitmap image) throws NotFoundException &#123;</span><br><span class="line">  if (readers != null) &#123;</span><br><span class="line">    for (Reader reader : readers) &#123;</span><br><span class="line">      try &#123;</span><br><span class="line">        return reader.decode(image, hints);</span><br><span class="line">      &#125; catch (ReaderException re) &#123;</span><br><span class="line">        // continue</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  throw NotFoundException.getNotFoundInstance();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="QRCodeReader-java"><a href="#QRCodeReader-java" class="headerlink" title="QRCodeReader.java"></a>QRCodeReader.java</h4><p>QRCodeReader.java在“zxing-zxing-3.3.3\core\src\main\java\com\google\zxing\qrcode”文件夹下：<br>实现解码的函数为  public final Result decode(BinaryBitmap image, Map&lt;DecodeHintType,?&gt; hints)，在<br>  public Result decode(BinaryBitmap image) throws NotFoundException, ChecksumException, FormatException中被调用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public final Result decode(BinaryBitmap image, Map&lt;DecodeHintType,?&gt; hints)</span><br><span class="line">    throws NotFoundException, ChecksumException, FormatException &#123;</span><br><span class="line">  DecoderResult decoderResult;</span><br><span class="line">  ResultPoint[] points;</span><br><span class="line">  if (hints != null &amp;&amp; hints.containsKey(DecodeHintType.PURE_BARCODE)) &#123;</span><br><span class="line">    BitMatrix bits = extractPureBits(image.getBlackMatrix());</span><br><span class="line">    decoderResult = decoder.decode(bits, hints);</span><br><span class="line">    points = NO_POINTS;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    DetectorResult detectorResult = new Detector(image.getBlackMatrix()).detect(hints);</span><br><span class="line">    decoderResult = decoder.decode(detectorResult.getBits(), hints);</span><br><span class="line">    points = detectorResult.getPoints();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // If the code was mirrored: swap the bottom-left and the top-right points.</span><br><span class="line">  if (decoderResult.getOther() instanceof QRCodeDecoderMetaData) &#123;</span><br><span class="line">    ((QRCodeDecoderMetaData) decoderResult.getOther()).applyMirroredCorrection(points);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Result result = new Result(decoderResult.getText(), decoderResult.getRawBytes(), points, BarcodeFormat.QR_CODE);</span><br><span class="line">  List&lt;byte[]&gt; byteSegments = decoderResult.getByteSegments();</span><br><span class="line">  if (byteSegments != null) &#123;</span><br><span class="line">    result.putMetadata(ResultMetadataType.BYTE_SEGMENTS, byteSegments);</span><br><span class="line">  &#125;</span><br><span class="line">  String ecLevel = decoderResult.getECLevel();</span><br><span class="line">  if (ecLevel != null) &#123;</span><br><span class="line">    result.putMetadata(ResultMetadataType.ERROR_CORRECTION_LEVEL, ecLevel);</span><br><span class="line">  &#125;</span><br><span class="line">  if (decoderResult.hasStructuredAppend()) &#123;</span><br><span class="line">    result.putMetadata(ResultMetadataType.STRUCTURED_APPEND_SEQUENCE,</span><br><span class="line">                       decoderResult.getStructuredAppendSequenceNumber());</span><br><span class="line">    result.putMetadata(ResultMetadataType.STRUCTURED_APPEND_PARITY,</span><br><span class="line">                       decoderResult.getStructuredAppendParity());</span><br><span class="line">  &#125;</span><br><span class="line">  return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到该函数先检测图片中的二维码，检测到之后再进行解码：<br>检测二维码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DetectorResult detectorResult = new Detector(image.getBlackMatrix()).detect(hints);</span><br></pre></td></tr></table></figure>
<p>解码二维码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">decoderResult = decoder.decode(detectorResult.getBits(), hints);</span><br></pre></td></tr></table></figure>
<p>在这里我们可以看到上层得到的rawResult里包含的是什么内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Result result = new Result(decoderResult.getText(), decoderResult.getRawBytes(), points, BarcodeFormat.QR_CODE);</span><br></pre></td></tr></table></figure>
<p>points为Detector检测到的二维码的位置信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">points = detectorResult.getPoints();</span><br></pre></td></tr></table></figure>
<p>在QRCodeReader.java里还有一个特别的函数，对一张干净的二维码图片进行快速解码，得到bits信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * This method detects a code in a &quot;pure&quot; image -- that is, pure monochrome image</span><br><span class="line"> * which contains only an unrotated, unskewed, image of a code, with some white border</span><br><span class="line"> * around it. This is a specialized method that works exceptionally fast in this special</span><br><span class="line"> * case.</span><br><span class="line"> *</span><br><span class="line"> * @see com.google.zxing.datamatrix.DataMatrixReader#extractPureBits(BitMatrix)</span><br><span class="line"> */</span><br><span class="line">private static BitMatrix extractPureBits(BitMatrix image) throws NotFoundException </span><br></pre></td></tr></table></figure>
<h4 id="Decoder-java"><a href="#Decoder-java" class="headerlink" title="Decoder.java:"></a>Decoder.java:</h4><p>Decoder.java在“zxing-zxing-3.3.3\core\src\main\java\com\google\zxing\qrcode\decoder”文件夹下：<br>主要的解码函数是private DecoderResult decode(BitMatrix bits, Map&lt;DecodeHintType,?&gt; hints)和<br>private DecoderResult decode(BitMatrixParser parser, Map&lt;DecodeHintType,?&gt; hints)：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * &lt;p&gt;Decodes a QR Code represented as a &#123;@link BitMatrix&#125;. A 1 or &quot;true&quot; is taken to mean a black module.&lt;/p&gt;</span><br><span class="line"> *</span><br><span class="line"> * @param bits booleans representing white/black QR Code modules</span><br><span class="line"> * @param hints decoding hints that should be used to influence decoding</span><br><span class="line"> * @return text and bytes encoded within the QR Code</span><br><span class="line"> * @throws FormatException if the QR Code cannot be decoded</span><br><span class="line"> * @throws ChecksumException if error correction fails</span><br><span class="line"> */</span><br><span class="line">public DecoderResult decode(BitMatrix bits, Map&lt;DecodeHintType,?&gt; hints)</span><br><span class="line">    throws FormatException, ChecksumException &#123;</span><br><span class="line"></span><br><span class="line">  // Construct a parser and read version, error-correction level</span><br><span class="line">  BitMatrixParser parser = new BitMatrixParser(bits);</span><br><span class="line">  FormatException fe = null;</span><br><span class="line">  ChecksumException ce = null;</span><br><span class="line">  try &#123;</span><br><span class="line">    return decode(parser, hints);</span><br><span class="line">  &#125; catch (FormatException e) &#123;</span><br><span class="line">    fe = e;</span><br><span class="line">  &#125; catch (ChecksumException e) &#123;</span><br><span class="line">    ce = e;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  try &#123;</span><br><span class="line"></span><br><span class="line">    // Revert the bit matrix</span><br><span class="line">    parser.remask();</span><br><span class="line"></span><br><span class="line">    // Will be attempting a mirrored reading of the version and format info.</span><br><span class="line">    parser.setMirror(true);</span><br><span class="line"></span><br><span class="line">    // Preemptively read the version.</span><br><span class="line">    parser.readVersion();</span><br><span class="line"></span><br><span class="line">    // Preemptively read the format information.</span><br><span class="line">    parser.readFormatInformation();</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">     * Since we&#x27;re here, this means we have successfully detected some kind</span><br><span class="line">     * of version and format information when mirrored. This is a good sign,</span><br><span class="line">     * that the QR code may be mirrored, and we should try once more with a</span><br><span class="line">     * mirrored content.</span><br><span class="line">     */</span><br><span class="line">    // Prepare for a mirrored reading.</span><br><span class="line">    parser.mirror();</span><br><span class="line"></span><br><span class="line">    DecoderResult result = decode(parser, hints);</span><br><span class="line"></span><br><span class="line">    // Success! Notify the caller that the code was mirrored.</span><br><span class="line">    result.setOther(new QRCodeDecoderMetaData(true));</span><br><span class="line"></span><br><span class="line">    return result;</span><br><span class="line"></span><br><span class="line">  &#125; catch (FormatException | ChecksumException e) &#123;</span><br><span class="line">    // Throw the exception from the original reading</span><br><span class="line">    if (fe != null) &#123;</span><br><span class="line">      throw fe;</span><br><span class="line">    &#125;</span><br><span class="line">    throw ce; // If fe is null, this can&#x27;t be</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private DecoderResult decode(BitMatrixParser parser, Map&lt;DecodeHintType,?&gt; hints)</span><br><span class="line">    throws FormatException, ChecksumException &#123;</span><br><span class="line">  Version version = parser.readVersion();</span><br><span class="line">  ErrorCorrectionLevel ecLevel = parser.readFormatInformation().getErrorCorrectionLevel();</span><br><span class="line"></span><br><span class="line">  // Read codewords</span><br><span class="line">  byte[] codewords = parser.readCodewords();</span><br><span class="line">  // Separate into data blocks</span><br><span class="line">  DataBlock[] dataBlocks = DataBlock.getDataBlocks(codewords, version, ecLevel);</span><br><span class="line"></span><br><span class="line">  // Count total number of data bytes</span><br><span class="line">  int totalBytes = 0;</span><br><span class="line">  for (DataBlock dataBlock : dataBlocks) &#123;</span><br><span class="line">    totalBytes += dataBlock.getNumDataCodewords();</span><br><span class="line">  &#125;</span><br><span class="line">  byte[] resultBytes = new byte[totalBytes];</span><br><span class="line">  int resultOffset = 0;</span><br><span class="line"></span><br><span class="line">  // Error-correct and copy data blocks together into a stream of bytes</span><br><span class="line">  for (DataBlock dataBlock : dataBlocks) &#123;</span><br><span class="line">    byte[] codewordBytes = dataBlock.getCodewords();</span><br><span class="line">    int numDataCodewords = dataBlock.getNumDataCodewords();</span><br><span class="line">    correctErrors(codewordBytes, numDataCodewords);</span><br><span class="line">    for (int i = 0; i &lt; numDataCodewords; i++) &#123;</span><br><span class="line">      resultBytes[resultOffset++] = codewordBytes[i];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // Decode the contents of that stream of bytes</span><br><span class="line">  return DecodedBitStreamParser.decode(resultBytes, version, ecLevel, hints);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Detector-java"><a href="#Detector-java" class="headerlink" title="Detector.java:"></a>Detector.java:</h4><p>Detector.java在“zxing-zxing-3.3.3\core\src\main\java\com\google\zxing\qrcode\detector”文件夹下：<br>在这里可以看到points里面存放的位置信息的结构：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if (alignmentPattern == null) &#123;</span><br><span class="line">  points = new ResultPoint[]&#123;bottomLeft, topLeft, topRight&#125;;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">  points = new ResultPoint[]&#123;bottomLeft, topLeft, topRight, alignmentPattern&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>bottomLeft, topLeft, topRight为二维码的三个定位点：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FinderPattern topLeft = info.getTopLeft();</span><br><span class="line">FinderPattern topRight = info.getTopRight();</span><br><span class="line">FinderPattern bottomLeft = info.getBottomLeft();</span><br></pre></td></tr></table></figure>
<p>对FinderPattern的定义在FinderPattern.java里：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">FinderPattern(float posX, float posY, float estimatedModuleSize) &#123;</span><br><span class="line">  this(posX, posY, estimatedModuleSize, 1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private FinderPattern(float posX, float posY, float estimatedModuleSize, int count) &#123;</span><br><span class="line">  super(posX, posY);</span><br><span class="line">  this.estimatedModuleSize = estimatedModuleSize;</span><br><span class="line">  this.count = count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，topLeft的x,y两个值为float类型的。</p>
</div><div class="post-copyright"><script type="text/javascript" src="/js/copyright.js?v=1.0.0" successtext="复制成功！"></script><link rel="stylesheet" type="text/css" href="/css/copyright.css?v=1.0.0"><p><span>本文标题：</span>分析google的Zxing条码扫描库源码</p><p><span>文章作者：</span>Mr Bluyee</p><p><span>发布时间：</span>2018-08-02</p><p><span>最后更新：</span>2019-07-15</p><p><span>原始链接：</span><a href="/2018/08/02/分析google的Zxing条码扫描库源码/">https://www.mrbluyee.com/2018/08/02/%E5%88%86%E6%9E%90google%E7%9A%84Zxing%E6%9D%A1%E7%A0%81%E6%89%AB%E6%8F%8F%E5%BA%93%E6%BA%90%E7%A0%81/</a><span class="copy-path"><i class="fa fa-clipboard" data-clipboard-text="https://www.mrbluyee.com/2018/08/02/%E5%88%86%E6%9E%90google%E7%9A%84Zxing%E6%9D%A1%E7%A0%81%E6%89%AB%E6%8F%8F%E5%BA%93%E6%BA%90%E7%A0%81/"></i></span></p><p><span>版权声明：</span>The author owns the copyright, please indicate the source reproduced.</p></div><br><div class="tags"><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/android/" rel="tag">android</a></li></ul></div><div class="post-nav"><a class="pre" href="/2018/08/05/%E4%B8%80%E8%A1%8C%E4%BB%A3%E7%A0%81%E8%B0%83%E7%94%A8Zxing%E7%9A%84%E4%BA%8C%E7%BB%B4%E7%A0%81%E8%A7%A3%E7%A0%81%E5%8A%9F%E8%83%BD/">一行代码调用Zxing的二维码解码功能</a><a class="next" href="/2018/08/01/C%E8%AF%AD%E8%A8%80%E7%9A%84interpositioning/">C语言的interpositioning</a></div><div id="lv-container" data-id="city" data-uid="MTAyMC8zOTYxNS8xNjE0Mg"><script>(function(d, s) {
  var j, e = d.getElementsByTagName(s)[0];
  if (typeof LivereTower === 'function') { return; }
  j = d.createElement(s);
  j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
  j.async = true;
  e.parentNode.insertBefore(j, e);
})(document, 'script');
</script></div></div></div></div><div class="pure-u-1 pure-u-md-1-4"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="author-info"><a class="info-avatar" href="/about/" title="关于"><img class="nofancybox" src="/img/avatar.jpeg"/></a><p>Enjoy life / Hope for future</p><a class="info-icon" href="mr.bluyee@hotmail.com" title="mr.bluyee@hotmail.com" target="_blank" style="margin-inline:5px"> <i class="fa fa-envelope-square" style="margin-inline:5px"></i></a><a class="info-icon" href="https://github.com/MrBluyee" title="https://github.com/MrBluyee" target="_blank" style="margin-inline:5px"> <i class="fa fa-github-square" style="margin-inline:5px"></i></a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94C-%E7%AE%97%E6%B3%95/">学习笔记——C 算法</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94C%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">学习笔记——C数据结构</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94Python/">学习笔记——Python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94android/">学习笔记——android</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94data-compression/">学习笔记——data compression</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94expert-c-programming/">学习笔记——expert c programming</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94linux/">学习笔记——linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94opencv/">学习笔记——opencv</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E4%BB%A3%E7%A0%81%E7%AE%A1%E7%90%86/">学习笔记——代码管理</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E4%BD%8E%E5%8A%9F%E8%80%97%E6%8A%80%E6%9C%AF/">学习笔记——低功耗技术</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/">学习笔记——嵌入式开发</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/">学习笔记——机器学习</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E7%89%A9%E8%81%94%E7%BD%91/">学习笔记——物联网</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/">学习笔记——网络协议</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F/">学习笔记——计算机系统</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F/" style="font-size: 15px;">计算机系统</a> <a href="/tags/android/" style="font-size: 15px;">android</a> <a href="/tags/C/" style="font-size: 15px;">C</a> <a href="/tags/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/" style="font-size: 15px;">网络协议</a> <a href="/tags/Python/" style="font-size: 15px;">Python</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/" style="font-size: 15px;">嵌入式开发</a> <a href="/tags/data-compression/" style="font-size: 15px;">data compression</a> <a href="/tags/opencv/" style="font-size: 15px;">opencv</a> <a href="/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/" style="font-size: 15px;">机器学习</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2024/03/25/zlib-and-gzip-format/">zlib and gzip format</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/03/23/deflate%20format/">deflate format</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/23/IPsec/">IPsec</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/07/21/%E6%95%B0%E7%9A%84%E7%B4%A0%E6%80%A7%E6%B5%8B%E8%AF%95/">数的素性测试</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/07/20/%E6%89%A9%E5%B1%95%E7%9A%84%E6%AC%A7%E5%87%A0%E9%87%8C%E5%BE%97%E7%AE%97%E6%B3%95/">扩展的欧几里得算法</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/07/17/%E6%AC%A7%E5%87%A0%E9%87%8C%E5%BE%97%E7%AE%97%E6%B3%95-%E6%B1%82%E6%9C%80%E5%A4%A7%E5%85%AC%E5%9B%A0%E6%95%B0/">欧几里得算法-求最大公因数</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/04/%E5%B8%B8%E7%94%A8%E8%B7%AF%E7%94%B1%E6%96%B9%E5%BC%8F/">常用路由方式</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/19/%E6%97%A0%E7%BA%BF%E4%BC%A0%E6%84%9F%E7%BD%91WSN%E6%A6%82%E8%BF%B0/">无线传感网WSN概述</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/18/%E6%97%A0%E7%BA%BF%E6%A8%A1%E5%9D%97%E4%BC%91%E7%9C%A0%E4%B8%8E%E6%BF%80%E6%B4%BB%E6%9C%BA%E5%88%B6/">无线模块休眠与激活机制</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/16/SOC%E7%9A%84%E4%BD%8E%E5%8A%9F%E8%80%97%E8%AE%BE%E8%AE%A1/">SOC的低功耗设计</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2024 <a href="/." rel="nofollow">Mr Bluyee's Blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.js"></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0"></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.css"><link rel="stylesheet" type="text/css" href="/css/search.css?v=1.0.0"><script type="text/javascript" src="/js/search.js?v=1.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
  search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/copycode.js?v=1.0.0" successtext="复制成功！"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css?v=1.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>